<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Mapa Interactivo — Municipios de Honduras</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html,body,#map{height:100%;margin:0;padding:0}
    #map{height:calc(100vh - 70px)}
    body{font-family:system-ui,Segoe UI,Roboto,Arial}
    .topbar{padding:10px;background:#0b63a4;color:#fff;display:flex;align-items:center;gap:12px}
    .legend{background:#fff;padding:8px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.2)}
    .info{padding:6px}
  </style>
</head>

<body>

<div class="topbar">
  <strong>Mapa interactivo — Municipios de Honduras</strong>
  <div style="margin-left:auto;display:flex;gap:10px;">
    <label style="font-size:13px">Visualizar por:</label>
    <select id="mode">
      <option value="percent">% Cambio (2021 → 2025)</option>
      <option value="difference">Diferencia absoluta</option>
    </select>
    <button id="resetView">Reset</button>
  </div>
</div>

<div id="map"></div>
<div id="legend" style="position:absolute;right:12px;top:80px;z-index:1000"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<script>

  /* ===========================================================
     CONFIGURACIÓN: SOLO EDITA ESTAS DOS VARIABLES
  ============================================================ */

  const DRIVE_API_KEY = "AIzaSyBINitDw4aRrCBCp5gDtbISwUK6MnzJuas";  
  const DRIVE_FILE_ID = "1cW00u-vWp-UyAl2zY4f-nFG_rtjtYcuO";       

  /* ===========================================================
     UTILIDADES
  ============================================================ */

  function normalizeName(s){
    return s?.toString().trim().toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .replace(/\s+/g,' ')
      .replace(/[^a-z0-9 ]/g,'') || "";
  }

  const colorRamp = ['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#3182bd','#08519c'];

  function getColorForValue(v, breaks){
    for(let i=0;i<breaks.length;i++) if(v<=breaks[i]) return colorRamp[i];
    return colorRamp[colorRamp.length-1];
  }

  /* ===========================================================
     MAPA
  ============================================================ */

  const map = L.map('map',{minZoom:6}).setView([15.0,-86.5],7);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18})
    .addTo(map);

  let geojsonLayer;
  let dataRows = {};
  let rawGeoJSON;
  let currentBreaks = [];

  /* ===========================================================
     Carga de CSV (data.csv)
  ============================================================ */

  Papa.parse("data.csv", {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete: res => {
      res.data.forEach(row=>{
        const key = normalizeName(row.Municipio || row.Municipality);
        dataRows[key] = {
          muni: row.Municipio || row.Municipality,
          dept: row.Departamento || row.Department,
          e21: Number(row.Electors2021 || 0),
          e25: Number(row.Electors2025 || 0),
          diff: Number(row.Difference || 0),
          pct: Number(row.PercentChange || 0)
        };
      });

      loadGeoJSONfromDrive();
    }
  });

  /* ===========================================================
     DESCARGA GEOJSON DESDE GOOGLE DRIVE (API OFICIAL)
  ============================================================ */

  function loadGeoJSONfromDrive(){
    const url = `https://www.googleapis.com/drive/v3/files/${DRIVE_FILE_ID}?alt=media&key=${DRIVE_API_KEY}`;

    fetch(url)
      .then(res=>res.json())
      .then(json=>{
        rawGeoJSON = json;
        preprocessGeoJSON();
        drawLayer("percent");
      })
      .catch(err=>alert("Error cargando GeoJSON desde Drive:\n"+err));
  }

  function preprocessGeoJSON(){
    rawGeoJSON.features.forEach(f=>{
      const p = f.properties;
      let name = p.MUNICIPIO || p.MUN_NOMBRE || p.NOMBRE || p.NAME;
      f.properties._norm = normalizeName(name);
      f.properties._show = name;
    });
  }

  /* ===========================================================
     Dibujar mapa
  ============================================================ */

  function computeBreaks(values, buckets){
    const arr = values.slice().sort((a,b)=>a-b);
    const results = [];
    for(let i=1;i<buckets;i++){
      results.push(arr[Math.floor(arr.length*(i/buckets))]);
    }
    return results;
  }

  function styleFeature(feature){
    const mode = document.getElementById("mode").value;
    const row = dataRows[feature.properties._norm];
    const v = row ? (mode==="percent" ? row.pct : row.diff) : null;
    return {
      weight:1,
      color:"#444",
      fillColor: v===null ? "#ccc" : getColorForValue(v,currentBreaks),
      fillOpacity: v===null ? .3 : .8
    };
  }

  function onEachFeature(feature, layer){
    const r = dataRows[feature.properties._norm];
    let html = `<div class="info"><strong>${feature.properties._show}</strong><br>`;

    if(r){
      html += `
        Depto: ${r.dept}<br>
        Electores 2021: ${r.e21.toLocaleString()}<br>
        Electores 2025: ${r.e25.toLocaleString()}<br>
        Diferencia: ${r.diff.toLocaleString()}<br>
        % Cambio: ${r.pct.toFixed(2)}%<br>
      `;
    } else {
      html += `<em>Sin datos</em>`;
    }

    html += `</div>`;
    layer.bindPopup(html);

    layer.on("mouseover", e => e.target.setStyle({weight:2}));
    layer.on("mouseout", e => geojsonLayer.resetStyle(e.target));
  }

  function drawLayer(mode){
    const vals = [];

    rawGeoJSON.features.forEach(f=>{
      const r = dataRows[f.properties._norm];
      if(r) vals.push(mode==="percent" ? r.pct : r.diff);
    });

    currentBreaks = vals.length
      ? computeBreaks(vals, colorRamp.length)
      : [0,1,2,3,4,5];

    if(geojsonLayer) map.removeLayer(geojsonLayer);

    geojsonLayer = L.geoJSON(rawGeoJSON, {
      style: styleFeature,
      onEachFeature: onEachFeature
    }).addTo(map);

    map.fitBounds(geojsonLayer.getBounds(),{padding:[20,20]});
    renderLegend(mode);
  }

  function renderLegend(mode){
    const div = document.getElementById("legend");
    div.innerHTML = "";

    const box = document.createElement("div");
    box.className = "legend";

    const title = mode==="percent"
      ? "% Cambio (2021–2025)"
      : "Diferencia absoluta";

    box.innerHTML = `<div style="font-weight:600;margin-bottom:6px">${title}</div>`;

    for(let i=0;i<currentBreaks.length;i++){
      box.innerHTML += `
        <div style="display:flex;align-items:center;">
          <div style="width:24px;height:12px;margin-right:8px;background:${colorRamp[i]}"></div>
          ${Math.round(currentBreaks[i])}
        </div>`;
    }

    div.appendChild(box);
  }

  document.getElementById("mode").addEventListener("change",()=>{
    drawLayer(document.getElementById("mode").value);
  });

  document.getElementById("resetView").addEventListener("click",()=>{
    map.fitBounds(geojsonLayer.getBounds());
  });

</script>

</body>
</html>
