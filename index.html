<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TREP-PD - Transmisión de Resultados Electorales Preliminares Poder Deportivo</title>
  <style>
    :root {
      --bg-color: #f4f7f6;
      --text-color: #212529;
      --text-muted-color: #6c757d;
      --brand-color: #1a237e;
      --card-bg: #ffffff;
      --card-shadow: rgba(0,0,0,0.1);
      --border-color: #dee2e6;
    }
    body.dark-theme {
      --bg-color: #0b1220;
      --text-color: #fff;
      --text-muted-color: rgba(255,255,255,0.7);
      --brand-color: #9fa8da;
      --card-bg: rgba(255,255,255,0.03);
      --card-shadow: rgba(0,0,0,0.4);
      --border-color: rgba(255,255,255,0.06);
    }
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg-color);color:var(--text-color);transition: background-color 0.3s, color 0.3s;}
    .container{padding:18px;max-width:1200px;margin:0 auto;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
    header .brand{font-size:1.2rem;font-weight:700; color: var(--brand-color);}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .card{background:var(--card-bg);padding:12px;border-radius:8px;box-shadow:0 6px 18px var(--card-shadow); transition: background-color 0.3s;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:8px;text-align:left;border-bottom:1px solid var(--border-color);}
    .small{font-size:0.85rem;color:var(--text-muted-color);}
    .big-number{font-size:2rem;font-weight:700;}
    #lastUpdated{font-size:0.9rem;color:var(--text-muted-color);}
    #theme-toggle {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">TREP-PD | Transmisión de Resultados Electorales Preliminares de Poder Deportivo</div>
      <button id="theme-toggle">Cambiar Tema</button>
      <div id="lastUpdated" class="small">Última actualización: --</div>
    </header>

    <div class="grid">
      <!-- Presidenciales -->
      <div class="card">
        <h3>Presidenciales</h3>
        <canvas id="chartPres" height="140"></canvas>
        <table id="tablePres" style="margin-top:10px">
          <thead><tr><th>Candidato</th><th>Votos</th><th>%</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Diputados (resumen) -->
      <div class="card">
        <h3>Diputados</h3>
        <canvas id="chartDip" height="140"></canvas>
        <table id="tableDip" style="margin-top:10px">
          <thead><tr><th>Candidato</th><th>Votos</th><th>%</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Alcaldes -->
      <div class="card" style="grid-column:1 / -1">
        <h3>Alcaldes</h3>
        <canvas id="chartAlc" height="90"></canvas>
        <table id="tableAlc" style="margin-top:10px">
          <thead><tr><th>Candidato</th><th>Votos</th><th>%</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* --- LÓGICA DEL TEMA OSCURO/CLARO --- */
const themeToggle = document.getElementById('theme-toggle');
const body = document.body;

// Función para aplicar el tema
function applyTheme(theme) {
  if (theme === 'dark') {
    body.classList.add('dark-theme');
    themeToggle.textContent = 'Tema Claro';
  } else {
    body.classList.remove('dark-theme');
    themeToggle.textContent = 'Tema Oscuro';
  }
  localStorage.setItem('theme', theme);
}

themeToggle.addEventListener('click', () => {
  const newTheme = body.classList.contains('dark-theme') ? 'light' : 'dark';
  applyTheme(newTheme);
});

/* CONFIG: Pega aquí la URL de tu aplicación web de Google Apps Script */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxJq8VFpY9yi9G5tWyPnQmue4Ww_6Yn_wS6ess2K0Qj3y78TnhaeF4sIkhnevw0L1AR/exec"; // <-- ¡REEMPLAZA ESTO!

const CSV_URL_PRES = `${SCRIPT_URL}?gid=0`;       // GID de la hoja de Presidenciales
const CSV_URL_DIP  = `${SCRIPT_URL}?gid=994753743`; // GID de la hoja de Diputados
const CSV_URL_ALC  = `${SCRIPT_URL}?gid=353257859`; // GID de la hoja de Alcaldes

/* Utility: simple CSV parser (works con CSV básico, sin comillas complejas) */
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/); // Más robusto para saltos de línea
  return lines.map(l => l.split(',').map(c => c.trim()));
}

/* Fetch and map CSV to {labels:[], totals:[]} */
async function fetchTotals(csvUrl) {
  const res = await fetch(csvUrl);
  if (!res.ok) throw new Error('CSV fetch failed: ' + res.status);
  const txt = await res.text();
  const rows = parseCSV(txt);
  // Necesitamos al menos 2 filas: cabeceras e imágenes
  if (rows.length < 2) return { labels: [], totals: [], imageUrls: [] };

  // Fila 1: Nombres de candidatos
  const labels = rows[0].map(h => h || 'SIN NOMBRE');
  // Fila 2: URLs de las imágenes
  const imageUrls = rows[1];

  // Sumar columnas de votos (a partir de la fila 3)
  const totals = new Array(labels.length).fill(0);
  for (let r = 2; r < rows.length; r++) {
    for (let c = 0; c < labels.length; c++) {
      const v = parseInt(rows[r][c] || '0',10);
      totals[c] += isNaN(v) ? 0 : v;
    }
  }
  return { labels, totals, imageUrls };
}

/* Chart helpers */
let chartPres=null, chartDip=null, chartAlc=null;

// Paleta de colores para los candidatos
const CHART_COLORS = ['#36a2eb', '#ff6384', '#4bc0c0', '#ff9f40', '#9966ff', '#ffcd56', '#c9cbcf'];

const candidateImagesPlugin = {
  id: 'candidateImages',
  async afterDraw(chart, args, options) {
    const { ctx } = chart;
    const { imageUrls } = options;
    if (!imageUrls || imageUrls.length === 0) return;

    const imageSize = 30; // Tamaño de la imagen en píxeles
    const meta = chart.getDatasetMeta(0);

    for (let i = 0; i < meta.data.length; i++) {
      const bar = meta.data[i];
      const imageUrl = imageUrls[i];
      if (!imageUrl || imageUrl.trim() === '') continue;

      // Usamos un caché simple para no recargar imágenes
      if (!chart.customImages) chart.customImages = {};
      let img = chart.customImages[imageUrl];

      if (!img) {
        img = new Image();
        img.src = imageUrl;
        chart.customImages[imageUrl] = img;
        // Si la imagen no ha cargado, la dibujamos en el siguiente ciclo de animación
        img.onload = () => chart.draw();
      }

      if (img.complete) {
        // Para barras horizontales, la imagen va a la izquierda, cerca de la etiqueta.
        // 'bar.y' es el centro vertical de la barra.
        // 'chart.chartArea.left' es donde empieza el área del gráfico.
        // Colocamos la imagen a la izquierda de esa área.
        const x = chart.chartArea.left - imageSize - 5;
        const y = bar.y - (imageSize / 2);

        ctx.save();
        ctx.beginPath();
        // Dibuja un círculo para recortar la imagen
        ctx.arc(x + imageSize / 2, y + imageSize / 2, imageSize / 2, 0, Math.PI * 2);
        ctx.closePath();
        ctx.clip();
        ctx.drawImage(img, x, y, imageSize, imageSize);
        ctx.restore();
      }
    }
  }
};

Chart.register(candidateImagesPlugin);

function renderBarChart(canvasId, labels, values, title, imageUrls){
  const ctx = document.getElementById(canvasId);
  if(!ctx) return;
  const data = {
    labels,
    datasets: [{
      label: title,
      data: values,
      backgroundColor: labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]),
    }]
  };
  const isDark = document.body.classList.contains('dark-theme');
  const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
  const labelColor = isDark ? 'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.8)';

  const cfg = {
    type:'bar',
    data,
    options:{
      indexAxis: 'y', // Barras horizontales para mejor legibilidad
      animation:false,
      // Ajusta el padding izquierdo para dar espacio a las imágenes y etiquetas largas
      layout: {
        padding: { left: 40 }
      },
      plugins: {
        legend:{display:false},
        candidateImages: { imageUrls } // Pasamos las URLs al plugin
      },
      scales: {
        y: { ticks: { color: labelColor }, grid: { color: gridColor } },
        x: { ticks: { color: labelColor }, grid: { color: gridColor } }
      }
    }
  };
  if(canvasId==='chartPres' && chartPres){ chartPres.destroy(); chartPres=null; }
  if(canvasId==='chartDip' && chartDip){ chartDip.destroy(); chartDip=null; }
  if(canvasId==='chartAlc' && chartAlc){ chartAlc.destroy(); chartAlc=null; }
  const chart = new Chart(ctx, cfg);
  if(canvasId==='chartPres') chartPres=chart;
  if(canvasId==='chartDip') chartDip=chart;
  if(canvasId==='chartAlc') chartAlc=chart;
  return chart;
}

/* Table render for presidenciales */
function renderTable(tableId, labels, values){
  const tbody = document.querySelector(`#${tableId} tbody`);
  if (!tbody) return;
  tbody.innerHTML = '';
  const total = values.reduce((a,b)=>a+b,0)||1;
  for(let i=0;i<labels.length;i++){
    const tr = document.createElement('tr');
    const p = Math.round((values[i]/total)*1000)/10;
    tr.innerHTML = `<td>${labels[i]}</td><td>${values[i].toLocaleString('es-HN')}</td><td>${p}%</td>`;
    tbody.appendChild(tr);
  }
}

/* Helper para ordenar los datos de mayor a menor */
function sortData(data) {
  // 1. Combina etiquetas y totales en un solo array de objetos
  const combined = data.labels.map((label, index) => ({
    label: label,
    total: data.totals[index],
    imageUrl: data.imageUrls[index] // Mantenemos la URL asociada
  }));

  // 2. Ordena el array combinado de mayor a menor voto
  combined.sort((a, b) => b.total - a.total);

  // 3. Separa nuevamente en dos arrays, ya ordenados
  const sortedLabels = combined.map(item => item.label);
  const sortedTotals = combined.map(item => item.total);
  const sortedImageUrls = combined.map(item => item.imageUrl);

  return { labels: sortedLabels, totals: sortedTotals, imageUrls: sortedImageUrls };
}

/* Main refresh flow */
async function refreshAll(){
  const statusEl = document.getElementById('lastUpdated');
  statusEl.textContent = 'Actualizando datos...';

  try{
    const t0 = Date.now();
    let [pres, dip, alc] = await Promise.all([ // Usamos 'let' para poder reasignar
      fetchTotals(CSV_URL_PRES),
      fetchTotals(CSV_URL_DIP),
      fetchTotals(CSV_URL_ALC),
    ]);

    // Ordenamos los datos de cada elección
    pres = sortData(pres);
    dip = sortData(dip);
    alc = sortData(alc);

    // Renderizamos todo con los datos ya ordenados
    renderBarChart('chartPres', pres.labels, pres.totals, 'Votos Presidenciales', pres.imageUrls);
    renderTable('tablePres', pres.labels, pres.totals);
    renderBarChart('chartDip', dip.labels, dip.totals, 'Votos Diputados', dip.imageUrls);
    renderTable('tableDip', dip.labels, dip.totals);
    renderBarChart('chartAlc', alc.labels, alc.totals, 'Votos Alcaldes', alc.imageUrls);
    renderTable('tableAlc', alc.labels, alc.totals);

    // last updated
    statusEl.textContent = 'Última actualización: ' + new Date().toLocaleString('es-HN');
    console.log('Refreshed in', Date.now()-t0,'ms');
  }catch(err){
    console.error('Refresh error',err);
    statusEl.textContent = 'Error actualizando: '+err.message;
  }
}

/* Auto-refresh */
// Al cargar la página, aplica el tema guardado o el preferido por el sistema
const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
applyTheme(savedTheme);

// Inicia la carga de datos
refreshAll(); // Carga inicial
setInterval(refreshAll, 120000); // Actualiza cada 2 minutos (ajustable)
</script>
</body>
</html>
